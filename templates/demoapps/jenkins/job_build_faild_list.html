{% extends 'demoapps/base.html' %}
{% load static %}
{% block css %}
<link href="https://magicbox.bk.tencent.com/static_api/v3/assets/bootstrap-3.3.4/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://magicbox.bk.tencent.com/static_api/v3/assets/datatables-1.10.7/dataTables.bootstrap.css" rel="stylesheet"/>
<link href="https://magicbox.bk.tencent.com/static_api/v3/bk/css/bk.css" rel="stylesheet">
{% endblock %}

{% block content %}
 <div class="king-layout1-content" style="margin-left:240px;margin-right: 20px">

{#    <div class="col-lg-6 col-xs-12 ml0 pl0">#}
        <div class="panel panel-default">
          <div class="box">
            <div class="box-header">
            </div>
            <!-- /.box-header -->
            <div class="box-body">
              <table id="example1" class="table table-hover mb0">
              </table>
            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
{#    </div>#}
    <!-- /.col -->

 </div>
{% endblock %}
<!-- ./wrapper -->

<!-- jQuery 3 -->
{% block js %}
    <script src="https://magicbox.bk.tencent.com/static_api/v3/assets/datatables-1.10.7/jquery.dataTables.js"></script>
<script src="https://magicbox.bk.tencent.com/static_api/v3/assets/datatables-1.10.7/dataTables.bootstrap.js"></script>

<script>
  $(function () {
    //table2_demo4_js_start
    //表格(DataTables)-4，综合示例
    var language = {
      search: '搜索：',
      lengthMenu: "每页显示 _MENU_ 记录",
      zeroRecords: "没找到相应的数据！",
      info: "分页 _PAGE_ / _PAGES_",
      infoEmpty: "暂无数据！",
      infoFiltered: "(从 _MAX_ 条数据中搜索)",
      processing : "正在获取数据，请稍后...",
      deferRender:true,//当处理大数据时，延迟渲染数据，有效提高Datatables处理能力
      {#loadingRecords: '正在获取数据，请稍后...',#}
      loadingRecords: '正在获取数据，请稍后...',
      paginate: {
        first: '首页',
        last: '尾页',
        previous: '上一页',
        next: '下一页',
      }
    };
    $("#example1").dataTable({
        autoWidth: false,
        lengthChange: true, //不允许用户改变表格每页显示的记录数
        pageLength : 10, //每页显示几条数据
        lengthMenu: [5, 10, 20], //每页显示选项
        pagingType: 'full_numbers',
        {#ajax : "{% url 'jenkins_a-api-url:job-building-list' %}",#}
        ajax: {
            "url": "{% url 'jenkins_a-api-url:job-build-failed-list' %}",
            "dataSrc": function ( json ) {
                return json;}
          },
        ordering: true,
        columns : [
          {title: "# id", data:"number"},
          {title: "任务", data:"name"},
          {title: "状态", render: function () {
              return "构建失败";
            }},
          {title: "时间", data:"detail.time"},
          {#{data:"start_date"},#}
          {#{data:"office"},#}
          {#{data:"extn"},#}
          {
            title: '操作',
            data:null,
            orderable:false,
            render : function(data, type, row, meta){
              htm = '<a class="btn btn-success console_log">输出日志</a>&nbsp;' +
                '<a class="btn btn-warning stop">停止构建</a>'
              return htm

            }
          },
          {
            orderable:false,
            render :function () {
              return "<i class=\"glyphicon glyphicon-chevron-down\" style=\"color:silver\"></i>"
              {#return "<i class=\"glyphicon glyphicon-chevron-up\" style=\"color:silver\"></i>"#}
            }
          }
        ],
        language:language
    });

    var t = $("#example1").DataTable();//获取datatables对象
    //停止按钮绑定事件
    $("#example1 tbody").on('click', 'a.stop', function(){
        var row = t.row($(this).parents('tr') ),//获取按钮所在的行
          data = row.data();
        console.log(data)
        if(confirm('确定要停止吗'+data.name+' ?')){
          row.remove().draw();
        }

    });
    // 点击按钮
    $("#example1 tbody").on('click', 'a.console_log', function(){
        var row = t.row($(this).parents('tr') ),//获取按钮所在的行
        data = row.data();
        output_console_log(data.name, data.number);

    });

    $("#example1 tbody").on('click', 'i.glyphicon', function(){
        build_faild_output_console_log_event(this, t);

    });

    //table2_demo4_js_end
  });

// 构建失败的日志查看
function build_faild_output_console_log_event(i_obj, t){
    var tr = $(i_obj).parents('tr');
    var row = t.row($(i_obj).parents('tr') ),//获取按钮所在的行
    data = row.data();
    var parameter = "?name=" + data.name + "&number=" + data.number;
    var ntr = $(tr).next()
    // 显示
    if($(i_obj).hasClass("glyphicon-chevron-down")){

        if(ntr.hasClass('detail')){
            ntr.attr('style', '')
        }else {
            $.ajax({
                method: "get",
                url:"{% url 'jenkins_a-url:job-build-console-input-api' %}" + parameter,
                success: function(data) {
                    build_console_output = data.build_console_output;
                    if (build_console_output) {
                      htm =  "<tr class=\"detail\" style=\"\">\n" +
                                "<td colspan=\"6\">\n" +
                                    "<pre >" +
                                        build_console_output +
                                    "</pre>" +
                "                        </td>\n" +
                "                    </tr>";
                      $(tr).after(htm);
                    }
                }
            });
        }
      $(i_obj).attr('class', 'glyphicon glyphicon-chevron-up')
    }
    // 隐藏
    else {
        $(i_obj).attr('class', 'glyphicon glyphicon-chevron-down');
        ntr.attr('style', 'display: none;')
    }
}
</script>
{% endblock %}
